﻿﻿**tomcat中的Session管理：**###一. Tomcat中Session对象：Session管理器使用          StandardSessionFacade类进行管理，其中StandardSessionFacade是   StandardSession的一个包装类. >1.StandardSession实现Session接口和HttpSession接口。 >>实例化时需要传入一个Session管理器Manger，其中getSession（）方法会实例化一个StandardSessionFacade返回。  >2.StandardSessionFacade实现HttpSession接口。  >>防止HttpSession转型为StandardSession。  >3.Session接口的几个方法：  >>1.get/setManger():Session实例与管理器相接。 2.get/setId():Session的标识符。 3.getLastAccessedTime():返回Session对象是否有效。 4.expire（）：设置为过期。###二. Session管理器Mangers：负责管理Session对象的创建和销毁。-实现架构：>Manager接口>>ManagerBase抽象工具类>>>StandardManager类>>>PersistentManagerBase类>>>>PersistentManager类和DistrlbutedManager类1. Manager接口中的重要方法：  get/setContainer()使一个Manager与Context容器相连；createSession()方法创建Session实例；add（），remove（）方法把一个session添加/移除session池。 1. ManagerBase类： 所有Session管理器组件继承此类1. StandardManager类： Manager接口的标准实现，实现Lifecycle接口与关联的Context容器同步。1. PersistentManagerBase类： 所有持久化Session管理器的父类，其使用Store对象进行引用。###三.存储器：为Session管理器管理的对象提供持久化存储。-实现架构：>Store接口类>>StoreBase抽象类>>>FileStore实现类和JDBCStore实现类1. Store接口重要方法： save()方法把指定的session对象存储到持久化存储器中；load()方法从存储器中依据sessionID把session加载到内存中。1. StoreBase类： 提供基本功能，子类去实现1. FileStore类： 把session对象存贮到某个文件（“.session”）。###四.程序实例：(context容器使用StandardManager管理session)程序架构：>Bootstrap启动类>SimpleContextConfig类：LifecycleListener实现类>SimplePipeline类：Pipeline的实例。>SimpleWrapper类：Wrapper容器的实例。>SimpleWrapperValve类：Valve的实例。>myApp>>WEB-INF>>>classes>>>>SessionServlet (测试使用的servlet)# Bootstrap实现： 首先设置系统属性catalina的值，实例化链接器connector，创建一个Wrapper容器与相应的servlet相连，实例化一个StandardContext容器，为其添加：wrapper容器，LifecycleListener监听器实例，类的载入器loader，同时关联一个StandardManager实例关联session。最后链接器初始化，启动程序。# SimpleWrapper实例的实现：## 类中的属性：>Servlet instance:加载/请求得到的servlet实例。>String servletClass>Loader loader:类加载器>String name:Wrapper容器名>LifecycleSupport lifecycle:Lifecycle工具类>SimplePipeline pipeline:’管道‘的实例>Container parent:与其相关联的父容器>boolean started:判断此容器是否已经通过Lifecycle的方式启动。## 类中一些重要方法：- SimpleWrapper()：构造函数，为与当前容器相关联的管道创建一个基础阈，阈值类为SimpleWrapperValve类的实例。- 填充类中属性的每一个set/get方法- allocate()：通过loadServlet()方法实例化instance.-  loadServlet():通过类加载器加载一个servlet实例- invoke(Request request, Response response)：调用与当前容器相关联的管道实例的invoke方法- start()：此类实现了Lifecycle接口，在此方法中统一启动实现了Lifecycle的Loader实例以及Pipeline实例，并且通过LifecycleSupport工具类填充事件的监听。- stop（）：与start（）类似，不过关闭前需要掉用Servlet实例的destory（）函数进行释放，之后统一关闭loader，pipeline实例。#SimplePipeline实例的实现：## 类中的属性：>Valve basic:基础阈值> Container container:与当前管道相关联的容器>Valve valves[]:阈值数组，用户可添加多个阈值## 类中一些重要方法：- SimplePipeline(Container container)：设置与当前管道相关联的容器- addValve(Valve valve)：把阈值valve添加到数组中- 填充set/get方法- 内部类StandardPipelineValveContext：提供方法invokeNext(Request request, Response response)处理基础阈或者添加的阈值数组中的阀（调用相应阀的invoke方法）。- invoke(Request request, Response response)：使用内部类来处理当前管道中的阀值。#SimpleWrapperValve实例实现(暂时理解为基础阀值类的实现)：## 类中的属性：>Container container：获得相关联的容器（wrapper）## 类中一些重要方法：- invoke(Request request, Response response, ValveContext valveContext):通过获得相应的wrapper容器，以此来构造HttpServletRequest和HttpServletResponse，同时需要获得当前wrapper容器的父容器context，为当前的requset对象提供context对象，使得二者相关联，在此处关联的作用是：实现HttpServletRequest接口中getSession()方法。（此处调用此方法时request需要寻找相关联的context对象）。之后，通过之前获得的wrapper实例对象的allocate（）方法实例化一个servelt，在调用其service方法。 